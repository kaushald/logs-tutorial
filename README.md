# Wizarding World: Magical Misadventures Platform - Observability Tutorial

Welcome to the **Magical Misadventures Platform** tutorial repository! This tutorial will guide you through setting up a NestJS-based backend application featuring a Harry Potter-themed platform where you can experience magical misadventures like time travel, artifact management, and potion brewing. This repo will teach you how to add observability with **logging**, **metrics**, and **tracing**. You'll also learn how to run performance tests using **K6** and visualize the results in **Kibana** and **Grafana**.

## **Table of Contents**

1. [Introduction](#introduction)
2. [Prerequisites](#prerequisites)
3. [Setup Instructions](#setup-instructions)
4. [Running the Application](#running-the-application)
5. [Performance Testing with K6](#performance-testing-with-k6)
6. [Analyzing Logs in Kibana](#analyzing-logs-in-kibana)
7. [Creating Visualizations in Kibana](#creating-visualizations-in-kibana)
8. [Troubleshooting and Tips](#troubleshooting-and-tips)
9. [Contributing](#contributing)
10. [License](#license)

## **Introduction**

In this tutorial, you will:

- Set up a backend application using NestJS with Harry Potter-themed functionalities.
- Implement logging with the ELK stack (Elasticsearch, Logstash, and Kibana).
- Run performance tests using the K6 tool to generate realistic load on the app.
- Create meaningful queries, visualizations, and dashboards in Kibana to analyze the logs.

## **Prerequisites**

Before you begin, ensure you have the following installed on your machine:

- **Node.js** (version 14 or higher)
- **Docker** and **Docker Compose**
- **K6** (for performance testing)
- A modern web browser for accessing **Kibana**

## **Setup Instructions**

1. **Clone the Repository**

   Clone this repository to your local machine:

   `git clone https://github.com/kaushald/logs-tutorial.git`  
   `cd time-travel-system-tutorial`

2. **Install Dependencies**

   Install the necessary dependencies for the NestJS application:

   `npm install`

3. **Set Up ELK Stack with Docker Compose**

   Use Docker Compose to set up Elasticsearch, Logstash, and Kibana:

   `docker-compose up -d`

   This will start Elasticsearch on `localhost:9200`, Logstash on `localhost:5044`, and Kibana on `localhost:5601`.

4. **Check Kibana Access**

   Once the stack is up and running, open your browser and go to [http://localhost:5601](http://localhost:5601) to access Kibana.

## **Running the Application**

1. **Start the NestJS Application**

   Run the following command to start the NestJS backend in development mode:

   `npm run start:dev`

   The application will start on `http://localhost:3000`.

2. **Available Endpoints**

   The application has the following endpoints:

   - **Booking API:** `GET /booking/create?destination=<destination>`
   - **Artifact API:** `GET /artifact/checkout?artifact=<artifact>&wizardLevel=<level>`
   - **Potion API:** `GET /potion/brew?ingredients=<ingredients>`

   You can use tools like **Postman** or **curl** to interact with these endpoints.

## **Performance Testing with K6**

1. **Prepare the K6 Test Environment**

   Make sure **K6** is installed on your system. If not, install it by following the instructions on the [K6 website](https://k6.io/docs/getting-started/installation).

2. **Run the K6 Test Script**

   We have provided a K6 script to test all APIs with varied input data. Run the following command to execute the performance test:

   `k6 run k6-tests/test-all-apis-with-rate.js`

   The test script uses data from CSV files located in `k6-tests/data/` to generate realistic load and log different scenarios.

## **Analyzing Logs in Kibana**

Once the application and ELK stack are set up and running, you can use **Kibana** to analyze the logs generated by the **Wizarding World: Magical Misadventures Platform**. Kibana provides a powerful interface to search, visualize, and analyze logs, helping you gain insights into application behavior, detect errors, and monitor performance.

### **Step-by-Step Guide to Analyzing Logs in Kibana**

### **1. Access the Kibana Discover Tab**

1. Open Kibana in your web browser by navigating to [http://localhost:5601](http://localhost:5601).
2. Click on the **"Discover"** tab in the left-hand menu.
3. Select the **index pattern** `logstash-*` (this pattern should cover all logs indexed by Logstash).
4. Adjust the **time range** in the top right corner to match the period you want to analyze (e.g., "Last 15 minutes," "Last 24 hours," or a custom range).

### **2. Understanding Log Fields in Kibana**

When you load the logs, you will see a table with various fields. Some important fields to note:

- **@timestamp**: The time the log was generated.
- **req.url**: The API endpoint that was accessed.
- **res.statusCode**: The HTTP status code returned by the endpoint.
- **responseTime**: The time taken to process the request in milliseconds.
- **req.query.<parameter>**: The query parameters sent with the request (e.g., `req.query.ingredients` for the Potion API).
- **log.level**: The log level, such as `30` (info) or `40` (error), indicating the severity or type of log.

### **3. Crafting KQL Queries for Deeper Insights**

Kibana Query Language (KQL) allows you to write custom queries to filter logs based on specific criteria. Here are some useful KQL queries:

#### **3.1 Viewing All Error Logs**

To filter and view all error logs:

`NOT res.statusCode: 200`

This query will show all logs where the response status code is not `200`, which usually indicates an error or failed request.

#### **3.2 Filtering by Specific API Endpoint**

To filter logs for a specific API endpoint, such as the **Potion API**:

`req.url: "/potion/brew*"`

This query retrieves all logs related to the **Potion API** endpoint, regardless of success or failure.

#### **3.3 Analyzing Errors for the Potion API**

To filter and analyze only the error logs for the **Potion API**:

`req.url: "/potion/brew*" AND NOT res.statusCode: 200`

This query combines conditions to retrieve only the error logs where the **Potion API** was called, allowing you to analyze what went wrong.

#### **3.4 Finding Slow Response Times for All APIs**

To identify logs where response times were longer than 500ms:

`responseTime > 500`

This query filters logs to show requests that took longer than 500 milliseconds to complete, helping you detect potential performance bottlenecks.

#### **3.5 Combining Queries for Detailed Analysis**

To combine multiple conditions, such as finding errors with high response times for the **Booking API**:

`req.url: "/booking/create*" AND NOT res.statusCode: 200 AND responseTime > 500`

This query helps you pinpoint the most problematic requests â€” those that are both slow and resulted in an error.

### **4. Visualizing Data for Better Insights**

Visualizing log data can help you quickly identify trends, patterns, and anomalies. Here are some recommended visualizations:

#### **4.1 Pie Chart: Success vs. Error Rate by API Endpoint**

1. **Go to:** Visualize Library > Create New Visualization > Pie Chart.
2. **Select:** The index pattern `logstash-*`.
3. **Buckets:** Split slices by `Terms` on the `req.url.keyword` field.
4. **Sub-Buckets:** Split slices by `Terms` on `res.statusCode` to show counts of success (`200`) and failures (other codes).
5. **Save:** This pie chart will show the proportion of successful vs. failed requests for each endpoint, helping you understand the overall reliability of your APIs.

#### **4.2 Histogram: Response Time Distribution for All APIs**

1. **Go to:** Visualize Library > Create New Visualization > Histogram.
2. **Select:** The index pattern `logstash-*`.
3. **X-Axis:** `Date Histogram` on `@timestamp`.
4. **Y-Axis:** `Average` on `responseTime`.
5. **Filter:** Add a filter for `res.statusCode: 200` to include only successful transactions.
6. **Save:** This histogram will show the average response time over time, allowing you to monitor performance trends and identify periods of high latency.

#### **4.3 Data Table: Top Ingredients with Highest Error Rate for Potion API**

1. **Go to:** Visualize Library > Create New Visualization > Data Table.
2. **Select:** The index pattern `logstash-*`.
3. **Buckets:** Split rows by `Terms` on the `req.query.ingredients.keyword` field.
4. **Metric:** `Count` on `res.statusCode != 200`.
5. **Save:** This table shows which ingredients (for potions) generate the most errors, providing insight into potential problematic inputs.

#### **4.4 Line Chart: Artifact Checkout Success Rate Over Time**

1. **Go to:** Visualize Library > Create New Visualization > Line Chart.
2. **Select:** The index pattern `logstash-*`.
3. **X-Axis:** `Date Histogram` on `@timestamp`.
4. **Y-Axis:** `Count` on `res.statusCode`.
5. **Split Lines:** By `Terms` on `req.url.keyword`.
6. **Save:** This line chart shows how often different artifacts are checked out successfully or fail over time.

#### **4.5 Heatmap: Response Time by API and Time**

1. **Go to:** Visualize Library > Create New Visualization > Heatmap.
2. **Select:** The index pattern `logstash-*`.
3. **X-Axis:** `Date Histogram` on `@timestamp`.
4. **Y-Axis:** `Terms` on `req.url.keyword`.
5. **Metric:** `Average` on `responseTime`.
6. **Save:** This heatmap provides a visual representation of response times across different APIs over time, making it easier to spot trends and anomalies.

### **5. Saving and Sharing Dashboards**

1. **Create a Dashboard:** Go to the Dashboards tab and click **Create New Dashboard**.
2. **Add Visualizations:** Add the visualizations created above to provide a comprehensive view of your application's performance and error rates.
3. **Customize:** Arrange the visualizations as needed and apply filters to refine your dashboard.
4. **Save and Share:** Save the dashboard and share it with your team for collaborative analysis.

### **6. Advanced Analysis with Kibana**

- **Use Filters and Query Bar:** You can create complex filters and use the query bar to refine your analysis. Save these filters for quick access in the future.
- **Drill Down with Lens:** Use Kibana Lens to drag and drop fields to explore your data more interactively and uncover new insights.

## **Troubleshooting and Tips**

- **Issue with Docker Compose:** Ensure Docker is running properly. Use `docker-compose logs` to troubleshoot.
- **K6 Test Fails:** Verify the APIs are up and running on `localhost:3000`.
- **Kibana Not Accessible:** Check if the ELK stack is running correctly by accessing `localhost:5601`.

## **Contributing**

Contributions are welcome! Please fork this repository, make your changes, and submit a pull request.

## **License**

This project is licensed under the MIT License.

---

Happy coding and enjoy your journey through observability with the Wizarding World: Magical Misadventures Platform!
